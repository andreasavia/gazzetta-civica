---
import { getLegge } from '../lib/leggi';

interface Props {
  codice: string;
}

const { codice } = Astro.props;
const legge = getLegge(codice);

// Format date without timezone issues
function formatDate(date: Date | string): string {
  const months = ['gennaio', 'febbraio', 'marzo', 'aprile', 'maggio', 'giugno',
                  'luglio', 'agosto', 'settembre', 'ottobre', 'novembre', 'dicembre'];
  if (typeof date === 'string') {
    // Handle DD/MM/YYYY format
    if (date.includes('/')) {
      const [day, month, year] = date.split('/').map(Number);
      return `${day} ${months[month - 1]} ${year}`;
    }
    // Handle YYYY-MM-DD format
    const [year, month, day] = date.split('-').map(Number);
    return `${day} ${months[month - 1]} ${year}`;
  }
  // For Date objects, use UTC to avoid timezone shifts
  return `${date.getUTCDate()} ${months[date.getUTCMonth()]} ${date.getUTCFullYear()}`;
}

// Extract law number from titolo-alternativo (e.g., "Legge n. 1/26 del..." -> "1/26")
function extractLawNumber(titolo: string): string {
  const match = titolo.match(/n\.\s*(\d+\/\d+)/);
  return match ? match[1] : '';
}
---

{legge && (
  <div class="scheda-informativa">
    <h2>Scheda Informativa</h2>
    <p class="scheda-sommario">
      Legge n. <a href={legge['normattiva-link']}><strong>{extractLawNumber(legge['titolo-alternativo'])}</strong></a> - Gazzetta Ufficiale <a href={legge['gu-link']}><strong>n. {legge['numero-gu']} del {formatDate(legge['data-gu'])}</strong></a>
    </p>
    <ul>
      {legge['data-vigenza'] && (
        <li><strong>Entrata in vigore</strong> {formatDate(legge['data-vigenza'])}</li>
      )}
      {legge['senato-natura'] && (
        <li><strong>Natura</strong> Legge {legge['senato-natura']}</li>
      )}
      {legge['camera-iniziativa'] && (
        <li><strong>Iniziativa</strong> {legge['camera-iniziativa']}</li>
      )}
      {legge['camera-firmatari'] && (
        <li><strong>Firmatari</strong> {legge['camera-firmatari'].map((f: string) => {
          const [name, group] = f.split(' - ');
          return `${name} (${group})`;
        }).join(', ')}</li>
      )}
      {(legge['camera-votazione-finale'] || legge['senato-votazione-finale']) && (
        <li><strong>Votazione finale</strong> <span>{legge['camera-votazione-finale'] && <a href={legge['camera-votazione-finale']}>Camera</a>}{legge['camera-votazione-finale'] && legge['senato-votazione-finale'] && ' | '}{legge['senato-votazione-finale'] && <a href={legge['senato-votazione-finale']}>Senato</a>}</span></li>
      )}
    </ul>
  </div>
)}
